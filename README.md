# Lightweight - Oxford Risk Auth Provider (Salesforce)
A lightweight Auth Provider implementation to connect to the Oxford Risk APIs using Named and External Credentials.

## Important Security Notes
- This code should always be installed as a MANAGED PACKAGE due to the password encryption key store
- The encryption key is stored in a PROTECTED custom setting 
- The encryption key is automatically generated and so it's **never** known to a human and **cannot** be extracted
- Protected custom settings are only secure when installed through a managed package
- Alternatively, implement a custom secure password storage solution and create a new package
- Frequently rotate the encryption key as a best practice

## Rotate the security key
- Encryption keys are generated by the system and are NOT VISIBLE or ACCESSIBLE by humans
- You only update the encryption key. After the update you need to re-encrypt the password and update your Auth Provider Settings
- Do this often and to do this at the same time as the password updates
- See the [Rotate Encryption Key Example](/examples/Rotate%20Encryption%20Key.apex) on how to execute the rotation code


## Package Info
|   |   |   |   |
|---|---|---|---|
|Package Name|**[Lightweight - Oxford Risk Auth Provider](https://github.com/jfwberg/lightweight-oxford-risk-auth-provider)**||
|Package Version|0.1.0-1||
|Last updated date|Aug 28, 2025||
|Managed Package | <ul><li> `sf package install --wait 30 --security-type AllUsers --package 04tP3000001PmTtIAK`</li><li>`/packaging/installPackage.apexp?p0=04tP3000001PmTtIAK`</li></ul> | [Install in Production](https://login.salesforce.com/packaging/installPackage.apexp?p0=04tP3000001PmTtIAK) | [Install in Sandbox](https://test.salesforce.com/packaging/installPackage.apexp?mgd=true&p0=04tP3000001PmTtIAK)|


## Dependencies
The following packages need to be installed before installing the main package in the order as below. If you are installing the `managed package` you need to install the **managed package** dependencies. The `unlocked package` is **NOT** availible due to the password encryption implementation.
|   |   |   |   |
|---|---|---|---|
|Package Name|**[Lightweight - Apex Unit Test Util v2](https://github.com/jfwberg/lightweight-apex-unit-test-util-v2)**||
|Package Version|2.5.0-1||
|Last updated date|Nov 5, 2024||
|Managed Package | <ul><li> `sf package install --wait 30 --security-type AllUsers --package 04tP3000000rUmLIAU`</li><li>`/packaging/installPackage.apexp?p0=04tP3000000rUmLIAU`</li></ul> | [Install in Production](https://login.salesforce.com/packaging/installPackage.apexp?p0=04tP3000000rUmLIAU) | [Install in Sandbox](https://test.salesforce.com/packaging/installPackage.apexp?mgd=true&p0=04tP3000000rUmLIAU)|


|   |   |   |   |
|---|---|---|---|
|Package Name|**[Lightweight - REST Util](https://github.com/jfwberg/lightweight-rest-util)**||
|Package Version|0.13.0-1||
|Last updated date|Dec 16, 2024||
|Managed Package | <ul><li> `sf package install --wait 30 --security-type AllUsers --package 04tP30000012SvhIAE`</li><li>`/packaging/installPackage.apexp?p0=04tP30000012SvhIAE`</li></ul> | [Install in Production](https://login.salesforce.com/packaging/installPackage.apexp?p0=04tP30000012SvhIAE) | [Install in Sandbox](https://test.salesforce.com/packaging/installPackage.apexp?mgd=true&p0=04tP30000012SvhIAE)|


## Optional Dependencies
The following packages are optional but recommended.
|   |   |   |   |
|---|---|---|---|
|Package Name|**[Lightweight - Auth Provider Util v2](https://github.com/jfwberg/lightweight-auth-provider-util)**||
|Package Version|0.12.0-1||
|Last updated date|Feb 13, 2024||
|Managed Package | <ul><li> `sf package install --wait 30 --security-type AllUsers --package 04tP3000000MVUzIAO`</li><li>`/packaging/installPackage.apexp?p0=04tP3000000MVUzIAO`</li></ul> | [Install in Production](https://login.salesforce.com/packaging/installPackage.apexp?p0=04tP3000000MVUzIAO) | [Install in Sandbox](https://test.salesforce.com/packaging/installPackage.apexp?mgd=true&p0=04tP3000000MVUzIAO)|
|Blog|[Managing User Context and (Error) Logging in Salesforce Auth Providers and Named/External Credentials](https://medium.com/@justusvandenberg/managing-user-context-and-error-logging-in-salesforce-auth-providers-and-named-external-283b0eaac4d)||



# Setup Steps
## Pre-Requisites
- Make sure to have an integration User in Salesforce you are ready to use to connect to the API
- Make sure you have the integration details availible to connect to the API (`email`, `password` and `subdomain`)

## 01) Install package dependencies
- Install all package dependencies using the links above or use the script in the scripts folder
- It's recommended to install the optional package for logging and debugging if that is necessary

## 02) Install Auth Provider package
- After installing the depenencies, install the main package


## 03) Assign permission sets for package to integration user / current user
- Assign the permission sets accordingly. See the bottom of the [Dependencies script](/scripts/01_package_dependencies.bat) for easy assignment.

## 04) Encrypt the API password
- After you have installed the package you need to encrypt this with the encryption key that is auto generated by the package.
- Run the code in the [Encrypt Password Example](/examples/Encrypt%20Password.apex) to generate your AES256 encrypted password
- If you use any tools like the dev console make sure that the plain text password is never stored or cached
- This is not a perfect method, but it's be simplest and most secure I can do in a secure lightweight implementation
- You'll need this password in the next step.
- Youre password should look something like this: `zm7Z478TXXUCBgRxLg1DTvSGFBj59d7jxfV79OkNv8I=`

## 05) Setup Auth. Provider Configuration
- Go to Setup > Auth. Providers, (note the dot at the end of “Auth.”)
- Click “New” and create a new Auth. Provider Using `the OxfordRiskAuthProvider` class as the provider type.
- Populate the `Execute Registration As` field first, this is a mandatory field that is not marked as mandatory and will reset the entire form if you forget it. The registration is not used. This field should be populated with the `Integration User`.
- Make sure that `Name`, `URL Suffix` and `Auth Provider Name` fields all **have the same value**.
- Populate the fields in the the Auth. Provider.
    - `Email` The email address you have registered for API access
    - `Password` The *encrypted* password from step 04
    - `Subdomain` The subdomain 
    - `Base URL` Leave this as is (https://org.oxfordrisk.io)
- If you have the optional Auth Provider Util package installed on the Salesforce Org you can check *Enable Error Logging* and  *Enable Login History*
- Press Save (Have some patience after clicking the button)
![image](/media/01%20-%20Auth%20Provider%20Config.png)

## 06) Setup External Credential
Your Auth Provider is now ready for testing. The next step is to create an External Credential that authenticates to the token endpoint(s) using the Auth Provider.

- Go to setup > Security > Named Credentials and click the `External Credentials` tab.
- Click `New`. Set A Label and a Name, in my Case `Oxford Risk`.
- Set Authentication Protocol to `OAuth 2.0`.
- Set Authentication Flow Type to `Browser Flow`. The Scope field can be left blank. This is overwritten by our Auth. Provider Settings.
- Select your created `Auth. Provider` from the `Auth Provider Picklist`. In my case `Oxford Risk`.
- You can ignore the `callout options` section
- Press the `Save` button.
![image](/media/02%20-%20External%20Credential%20Config.png)

## 07) Create an External Credential principal
Once saved, scroll down to the `Principals` section
- Click “New”, for a name give it something like `NAMED_PRINCIPAL`
- `Scope` can be left blank and the sequence can be kept default
- Keep the *identity type* as `Named Principal`
- Press `Save`
Leave the external credential open window open, we have to make a quick side step to setup the security that allows the integration user to use this credential.
![image](/media/03%20-%20Create%20Principal.png)

## 08) Create and assing permission set to integration user
To allow our integration user to connect through a Named / External Credential, we need to setup a permission set.
- In Setup go to Users >> Permission Sets and Click the `New` button
- In the *Label* put `Oxford Risk External Credential Access`
- The *API Name* should automatically populate
- The *License Type* dropdown can be kept to `None`
- Press “Save”
- Scroll down to the section called `External Credential Principal Access`
- Assign the `Oxford_Risk.NAMED_PRINCIPAL` principal from *Step 7* to the permission set and press `Save`.
- Assign this permission set to the `Integration User` now; forgetting this might cause head scratching later.
![image](/media/04%20-%20Permission%20Set.png)

## 09) Connect your External Credential to the API
You have now finished setting up the External Credential and the Auth Provider. The moment of truth…
- Go back to your `External Credential`.
- Click on the arrow button next to the `NAMED_PRINCIPAL` principal
- Click `Authenticate`, Salesforce now calls the token endpoint and executes the logic from the Apex class to get a token. It will redirect you to the same page (This is the redirect URL that is auto generated in the class.)
![image](/media/05%20-%20Autenticate.png)
- You'll get a popup message where you have to confirm you are OK with connecting on behalf of the logged in user
![image](/media/06%20-%20Confirm.png)
- If all goes well you get a green toast method saying you connected successfully. Congratulations! You’re now successfully authenticated.
![image](/media/07%20-%20Success.png)
- If you run into errors make sure to install the auth provider util and check the logs.
- The most common error is forgetting to assign a permission set to the integration user you're setting up the connection with

## 10) Setup Named Credential
Once you have successfully authenticated your External Credential, there is one more step required to use it from Apex or Flow to call an API: We need a Named Credential that uses the External Credential.

- Go to setup > Security > Named Credentials and click the Named Credentials tab
- Click `New` (Note we are NOT creating a legacy named credential, we’re creating a modern one)
- Give your credential a Label and a Name, I am going to be original and call it `Oxford Risk`.
- Populate the URL field with the base URL of the API: `https://org.oxfordrisk.io`
- Select your *External Credential* you created in Step 6
- Make sure `Generate Authorization Header` is selected, this is by default but check it just in case
- Optionally you can select a namespace and a network if you use private connect
- !! If you want to test out the demo component you'll need to add `lwt,utl`  in the `Allowed Namespaces for Callouts`
- Press `Save`
![image](/media/08%20-%20Named%20Credential.png)

## 11) Run Example Script
Lastly run the example script from [](/examples/Callout_Example.apex)
- This should give you a result and you're all set to go
- If you have any errors validate things like the remote site settings and the proper access setting by the running user